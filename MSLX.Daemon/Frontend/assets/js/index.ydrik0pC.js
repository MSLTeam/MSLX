import{r as X,u as oe,_ as le}from"./index.mEJ9vWkt.js";import{a as T,b as Q}from"./user.BNrhW7FS.js";import{M as u,D as H}from"./tdesign-vue-next.EnwhK9x8.js";import{z as se,f as ne,U as re,ad as ie,ag as de}from"./tdesign-icons-vue-next.DieAbZNO.js";import{D as me,F as g,W as K,P as ue,R as pe,aX as A,G as e,b2 as t,b0 as r,aY as _,a$ as m,ao as f,b5 as V,b1 as P,b6 as R,ap as h,O as ce}from"./index.BbdIPky0.js";import"./pinia.DE9DXmFR.js";import"./pinia-plugin-persistedstate.n2tMOXAx.js";import"./vue-router.CTuarHf7.js";import"./tvision-color.BU_YHHaJ.js";import"./chroma-js.Cmk4elvR.js";import"./bezier-easing.jp9ayU57.js";import"./lodash.BpjWTYO-.js";import"./axios.R-lXtGyY.js";import"./qs.CnepGyXr.js";import"./side-channel.Bf-JVZLg.js";import"./es-errors.CFxpeikN.js";import"./object-inspect.CD-SYzlK.js";import"./cron-parser.BqMfRICj.js";import"./luxon.BVaPVz1w.js";import"./side-channel-list.CQN2BsdT.js";import"./side-channel-map.BJ69Knz3.js";import"./get-intrinsic.CAdfHqt8.js";import"./es-object-atoms.Ditt1eQ6.js";import"./math-intrinsics.Cv-yPkyD.js";import"./gopd.fcd2-aIC.js";import"./es-define-property.bDCdrV83.js";import"./has-symbols.BaUvM3gb.js";import"./get-proto.Cbri-GHQ.js";import"./dunder-proto.q7lw_6_J.js";import"./call-bind-apply-helpers.BxcZtPLH.js";import"./function-bind.BbkWVFrm.js";import"./hasown.ckq0ukzO.js";import"./call-bound.BO70H6sD.js";import"./side-channel-weakmap.BkoVKe_V.js";import"./nprogress.CMq2Rk2a.js";import"./core-js-pure.DghWRT_o.js";import"./crelt.C8TCjufn.js";import"./style-mod.Bc2inJdb.js";import"./w3c-keyname.Vcq4gwWv.js";import"./lodash-es.ClUTdtmA.js";import"./mitt.DJ65BbbF.js";import"./sortablejs.C83syoBY.js";function fe(){return X.get({url:"/api/settings"})}function ge(I){return X.post({url:"/api/settings",data:I})}const _e={class:"settings-page"},ve={class:"profile-header"},ye={class:"avatar-col"},we={class:"info-col"},be={class:"main-row"},Ve={class:"nickname"},he={class:"sub-row"},Pe={class:"username"},qe={key:0,class:"last-login"},xe={class:"status-label"},ke=me({__name:"index",setup(I){const D=oe(),q=g(!1),x=g(!1),k=g(!1),S=g(!1),$=g(!1),o=K({id:"",username:"",name:"",avatar:"",role:"",apiKey:"",lastLoginTime:""}),L=g(""),n=K({changePassword:!1,newPassword:"",confirmPassword:""}),v=g("qq"),y=g(""),i=K({fireWallBanLocalAddr:!1,openWebConsoleOnLaunch:!0,neoForgeInstallerMirrors:"MSL Mirrors",listenHost:"localhost",listenPort:1027}),j=[{label:"官方源 (较慢)",value:"Official"},{label:"MSL镜像源 (推荐)",value:"MSL Mirrors"},{label:"MSL镜像源 - 备用",value:"MSL Mirrors Backup"}],B=async()=>{q.value=!0,x.value=!0;try{const[s,a]=await Promise.all([T(),fe()]);Object.assign(o,s),L.value=s.username;const p=s.avatar&&s.avatar.match(/nk=(\d+)/);p&&p[1]?(v.value="qq",y.value=p[1]):v.value="custom",Object.assign(i,a)}catch(s){u.error(s.message||"加载失败")}finally{q.value=!1,x.value=!1}};ue(y,s=>{v.value==="qq"&&s&&(o.avatar=`https://q.qlogo.cn/g?b=qq&nk=${s}&s=640`)});const E=s=>{s==="qq"&&y.value&&(o.avatar=`https://q.qlogo.cn/g?b=qq&nk=${y.value}&s=640`)},G=()=>{o.apiKey&&navigator.clipboard.writeText(o.apiKey).then(()=>{u.success("API Key 已复制")})},Y=()=>{const s=H.confirm({header:"重置 API 密钥",theme:"warning",body:"重置后，所有使用旧 Key 的外部工具将立即失效，确定要继续吗？",onConfirm:async()=>{try{s.hide(),await Q({resetApiKey:!0}),u.success("API Key 重置成功");const a=await T();o.apiKey=a.apiKey}catch(a){u.error(a.message||"重置失败")}}})},J=async()=>{if(n.changePassword){if(!n.newPassword){u.warning("请输入新密码");return}if(n.newPassword!==n.confirmPassword){u.error("两次输入的密码不一致");return}}const s=o.username!==L.value,a=n.changePassword&&!!n.newPassword;k.value=!0;try{const p={username:o.username,name:o.name,avatar:o.avatar,password:a?n.newPassword:void 0,resetApiKey:!1};await Q(p),n.changePassword=!1,n.newPassword="",n.confirmPassword="",L.value=o.username,u.success("个人信息保存成功"),s||a?H.alert({header:"重新登录",body:"账号或密码已变更，请重新登录以生效。",confirmBtn:"去登录",onConfirm:async()=>{await D.logout(),window.location.reload()}}):await D.getUserInfo()}catch(p){u.error(p.message)}finally{k.value=!1}},Z=async()=>{S.value=!0;try{await ge(i),u.success("系统设置保存成功")}catch(s){u.error(s.message)}finally{S.value=!1}};return pe(()=>{B()}),(s,a)=>{const p=r("t-avatar"),F=r("t-tag"),U=r("t-divider"),w=r("t-icon"),O=r("t-radio-button"),ee=r("t-radio-group"),c=r("t-input"),C=r("t-space"),d=r("t-form-item"),b=r("t-button"),M=r("t-switch"),z=r("t-form"),W=r("t-card"),ae=r("t-select"),N=r("t-col"),te=r("t-row");return _(),A("div",_e,[e(C,{direction:"vertical",size:"large",style:{width:"100%"}},{default:t(()=>[e(W,{bordered:!1,loading:x.value,class:"settings-card"},{default:t(()=>[m("div",ve,[m("div",ye,[e(p,{image:o.avatar,size:"80px",shape:"circle",class:"user-avatar-shadow"},{default:t(()=>[f(V(o.name?o.name.slice(0,1).toUpperCase():"U"),1)]),_:1},8,["image"])]),m("div",we,[m("div",be,[m("span",Ve,V(o.name||"未设置昵称"),1),o.role==="admin"?(_(),P(F,{key:0,theme:"success",variant:"light",size:"small",shape:"round"},{default:t(()=>[...a[13]||(a[13]=[f("管理员",-1)])]),_:1})):(_(),P(F,{key:1,theme:"primary",variant:"light",size:"small",shape:"round"},{default:t(()=>[...a[14]||(a[14]=[f("普通用户",-1)])]),_:1}))]),m("div",he,[m("span",Pe,"@"+V(o.username),1),o.lastLoginTime?(_(),A("span",qe,[e(h(se)),f(" "+V(new Date(o.lastLoginTime).toLocaleString()),1)])):R("",!0)])])]),e(U),e(z,{ref:"userForm",data:o,"label-width":100,"label-align":"left",onSubmit:J},{default:t(()=>[e(d,{label:"头像设置"},{default:t(()=>[e(C,{direction:"vertical",style:{width:"100%"}},{default:t(()=>[e(ee,{modelValue:v.value,"onUpdate:modelValue":a[0]||(a[0]=l=>v.value=l),variant:"default-filled",onChange:E},{default:t(()=>[e(O,{value:"qq"},{default:t(()=>[e(w,{name:"logo-qq"}),a[15]||(a[15]=f(" QQ头像",-1))]),_:1}),e(O,{value:"custom"},{default:t(()=>[e(w,{name:"link"}),a[16]||(a[16]=f(" 链接",-1))]),_:1})]),_:1},8,["modelValue"]),v.value==="qq"?(_(),P(c,{key:0,modelValue:y.value,"onUpdate:modelValue":a[1]||(a[1]=l=>y.value=l),placeholder:"输入QQ号自动获取",type:"number"},{"prefix-icon":t(()=>[e(w,{name:"user"})]),_:1},8,["modelValue"])):(_(),P(c,{key:1,modelValue:o.avatar,"onUpdate:modelValue":a[2]||(a[2]=l=>o.avatar=l),placeholder:"输入图片 URL 链接"},{"prefix-icon":t(()=>[e(w,{name:"image"})]),_:1},8,["modelValue"]))]),_:1})]),_:1}),e(d,{label:"用户昵称",name:"name"},{default:t(()=>[e(c,{modelValue:o.name,"onUpdate:modelValue":a[3]||(a[3]=l=>o.name=l),placeholder:"显示的名称"},null,8,["modelValue"])]),_:1}),e(d,{label:"登录账号",name:"username"},{default:t(()=>[e(c,{modelValue:o.username,"onUpdate:modelValue":a[4]||(a[4]=l=>o.username=l),placeholder:"登录唯一标识"},null,8,["modelValue"])]),_:1}),e(d,{label:"API Key",help:"用于第三方工具连接的凭证，请妥善保管"},{default:t(()=>[e(c,{value:o.apiKey,type:$.value?"text":"password",readonly:"",placeholder:"点击重置生成 Key"},{suffix:t(()=>[e(b,{variant:"text",size:"small",onClick:G},{icon:t(()=>[e(h(ne))]),_:1}),e(b,{variant:"text",theme:"danger",size:"small",onClick:Y},{icon:t(()=>[e(h(re))]),_:1})]),_:1},8,["value","type"])]),_:1}),e(U,{dashed:""}),e(d,{label:"修改密码"},{default:t(()=>[e(M,{modelValue:n.changePassword,"onUpdate:modelValue":a[5]||(a[5]=l=>n.changePassword=l)},null,8,["modelValue"])]),_:1}),n.changePassword?(_(),A(ce,{key:0},[e(d,{label:"新密码","required-mark":""},{default:t(()=>[e(c,{modelValue:n.newPassword,"onUpdate:modelValue":a[6]||(a[6]=l=>n.newPassword=l),type:"password",placeholder:"请输入新密码"},{"prefix-icon":t(()=>[e(h(ie))]),_:1},8,["modelValue"])]),_:1}),e(d,{label:"确认密码","required-mark":""},{default:t(()=>[e(c,{modelValue:n.confirmPassword,"onUpdate:modelValue":a[7]||(a[7]=l=>n.confirmPassword=l),type:"password",placeholder:"请再次输入新密码"},{"prefix-icon":t(()=>[e(h(de))]),_:1},8,["modelValue"])]),_:1})],64)):R("",!0),e(d,null,{default:t(()=>[e(b,{theme:"primary",type:"submit",loading:k.value,block:"",class:"action-btn"},{default:t(()=>[...a[17]||(a[17]=[f(" 保存个人资料 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["data"])]),_:1},8,["loading"]),e(W,{bordered:!1,title:"系统偏好设置",loading:q.value,class:"settings-card"},{actions:t(()=>[e(b,{theme:"primary",variant:"text",size:"small",onClick:B},{default:t(()=>[...a[18]||(a[18]=[f("刷新数据",-1)])]),_:1})]),default:t(()=>[e(z,{ref:"sysForm",data:i,"label-width":120,"label-align":"left",onSubmit:Z},{default:t(()=>[a[21]||(a[21]=m("div",{class:"group-title"},"守护进程",-1)),e(d,{label:"自动打开控制台",help:"MSLX 守护进程启动成功后，是否自动登录网页端控制台。"},{default:t(()=>[e(M,{modelValue:i.openWebConsoleOnLaunch,"onUpdate:modelValue":a[8]||(a[8]=l=>i.openWebConsoleOnLaunch=l)},null,8,["modelValue"])]),_:1}),e(d,{label:"安装镜像源",help:"选择在自动安装 NeoForge / Forge 时所使用的镜像源。",style:{"margin-top":"6px"}},{default:t(()=>[e(ae,{modelValue:i.neoForgeInstallerMirrors,"onUpdate:modelValue":a[9]||(a[9]=l=>i.neoForgeInstallerMirrors=l),options:j},null,8,["modelValue"])]),_:1}),e(U,{dashed:""}),a[22]||(a[22]=m("div",{class:"group-title"},"网络与安全",-1)),e(d,{label:"禁止本地访问",help:"开启后将禁止本地回环地址访问，增强安全性。"},{default:t(()=>[e(C,{align:"center"},{default:t(()=>[e(M,{modelValue:i.fireWallBanLocalAddr,"onUpdate:modelValue":a[10]||(a[10]=l=>i.fireWallBanLocalAddr=l)},null,8,["modelValue"]),m("span",xe,V(i.fireWallBanLocalAddr?"已开启":"已关闭"),1)]),_:1})]),_:1}),e(d,{label:"监听地址设置",help:"设置MSLX守护进程的监听地址。(需要重启守护进程生效,若不明白这是干什么的请一定不要修改！)",style:{"margin-top":"6px"}},{default:t(()=>[e(te,{gutter:16,style:{width:"100%"}},{default:t(()=>[e(N,{span:6},{default:t(()=>[e(c,{modelValue:i.listenHost,"onUpdate:modelValue":a[11]||(a[11]=l=>i.listenHost=l),placeholder:"localhost"},{"prefix-icon":t(()=>[e(w,{name:"server"})]),_:1},8,["modelValue"])]),_:1}),e(N,{span:4,style:{display:"flex","align-items":"center"}},{default:t(()=>[a[19]||(a[19]=m("span",{style:{"margin-right":"8px",color:"var(--td-text-color-secondary)"}},":",-1)),e(c,{modelValue:i.listenPort,"onUpdate:modelValue":a[12]||(a[12]=l=>i.listenPort=l),placeholder:"1027",style:{width:"120px"}},{"prefix-icon":t(()=>[e(w,{name:"control-platform"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(d,null,{default:t(()=>[e(b,{theme:"primary",type:"submit",loading:S.value,block:"",class:"action-btn"},{default:t(()=>[...a[20]||(a[20]=[f(" 保存系统设置 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["data"])]),_:1},8,["loading"])]),_:1})])}}}),ga=le(ke,[["__scopeId","data-v-c8ddd72e"]]);export{ga as default};
