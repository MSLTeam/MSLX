import{D as ve,F as C,K as q,aa as he,b1 as F,b2 as d,b0 as R,aY as n,a$ as i,aX as u,b6 as m,bh as B,aZ as me,G as c,ap as p,ao as b,b5 as f,O as ge,b3 as _e,b4 as ye,a_ as be}from"./index.CWeK9ocq.js";import{i as we,h as Ce,j as Fe,F as ze,_ as xe}from"./index.BNRycSAt.js";import{aG as Ie,X as K,at as Q,ad as Pe,aM as Me,aj as Ee,a as De,aL as Re,aI as Be,af as Te,aJ as Ue,aN as Ne}from"./tdesign-icons-vue-next.o89AUH_k.js";import{M as X}from"./tdesign-vue-next.ClIZ97Cx.js";const je={class:"uploader-container"},Ae={key:0,class:"drop-text"},Le={key:1,class:"drop-text"},Se={class:"drop-actions"},ke={key:0,class:"queue-actions"},Ve={class:"queue-info"},$e={key:0},Oe={class:"btn-group"},Ge={key:1,class:"file-list"},Ze={class:"file-icon-wrapper"},qe={class:"file-content"},Ke={class:"file-header"},Qe=["title"],Xe={class:"meta"},Ye={key:0,class:"error"},He={key:1},Je={class:"size"},We=["title"],es={class:"progress-wrapper"},ss={class:"file-action"},ts=ve({__name:"FileUploader",props:{visible:{type:Boolean},instanceId:{},currentPath:{},allowFolder:{type:Boolean,default:!0}},emits:["update:visible","success"],setup(T,{emit:Y}){const g=T,U=Y,l=C([]),_=C(!1),z=C(!1),N=C(),j=C(),A=e=>{var t;const s=(t=e.split(".").pop())==null?void 0:t.toLowerCase();return["png","jpg","jpeg","gif","ico","webp"].includes(s||"")?{icon:Re,color:"var(--td-success-color)"}:["jar","zip","rar","7z","tar","gz"].includes(s||"")?{icon:Be,color:"#722ed1"}:["js","ts","py","java","c","cpp","cs","json","yml","yaml","xml","html","css","properties","conf","sh","bat"].includes(s||"")?{icon:Te,color:"var(--td-warning-color)"}:["log","txt","md","lock"].includes(s||"")?{icon:Ue,color:"var(--td-gray-color-6)"}:["db","db-wal","dat"].includes(s||"")?{icon:Ne,color:"var(--td-gray-color-8)"}:{icon:K,color:"var(--td-brand-color)"}},x=e=>e.split("/").pop()||e,E=e=>{const s=e.lastIndexOf("/");return s!==-1?e.substring(0,s):""},H=q(()=>{if(l.value.length===0)return 0;const e=l.value.reduce((s,t)=>s+t.progress,0);return Math.floor(e/l.value.length)}),J=q(()=>l.value.some(e=>e.status==="pending"||e.status==="error")),W=()=>{var e;return(e=N.value)==null?void 0:e.click()},ee=()=>{var e;return(e=j.value)==null?void 0:e.click()},L=e=>{const s=e.target;if(s.files&&s.files.length>0){const a=Array.from(s.files).map(r=>({file:r,path:r.webkitRelativePath||r.name}));k(a)}s.value=""},se=async e=>{var r;z.value=!1;const s=(r=e.dataTransfer)==null?void 0:r.items;if(!s)return;const t=[],a=Array.from(s).map(o=>o.webkitGetAsEntry()).filter(o=>o!==null);for(const o of a)o&&await S(o,t);k(t)},S=async(e,s)=>{if(e.isFile){const t=await new Promise((r,o)=>e.file(r,o)),a=e.fullPath.startsWith("/")?e.fullPath.slice(1):e.fullPath;s.push({file:t,path:a})}else if(e.isDirectory)if(g.allowFolder){const t=e.createReader(),a=await te(t);for(const r of a)await S(r,s)}else X.error("此处不支持上传文件夹")},te=async e=>{let s=[];const t=async()=>{const a=await new Promise((r,o)=>e.readEntries(r,o));a.length>0&&(s=s.concat(a),await t())};return await t(),s},k=e=>{e.forEach(({file:s,path:t})=>{l.value.some(a=>a.path===t&&a.file.size===s.size&&a.status!=="error")||l.value.push({id:Math.random().toString(36).substring(2),file:s,path:t,status:"pending",progress:0,speed:""})})},oe=async()=>{if(_.value)return;_.value=!0;const e=3,s=l.value.filter(t=>t.status==="pending"||t.status==="error");for(let t=0;t<s.length;t+=e){const a=s.slice(t,t+e);await Promise.all(a.map(r=>ae(r)))}_.value=!1,l.value.every(t=>t.status==="success")&&(X.success("上传完成"),U("success"))},ae=async e=>{var t;e.status="uploading",e.progress=0,e.abortController=new AbortController;const s=Date.now();try{const r=(await we()).uploadId,y=e.file.size>200*1024*1024?50*1024*1024:10*1024*1024,w=Math.ceil(e.file.size/y),ie=4,V=5,$=Array.from({length:w},(v,h)=>h);let D=0;const ce=async v=>{var G,Z;if((G=e.abortController)!=null&&G.signal.aborted)throw new Error("已取消");const h=v*y,I=Math.min(e.file.size,h+y),O=e.file.slice(h,I);let P;for(let M=1;M<=V;M++){if((Z=e.abortController)!=null&&Z.signal.aborted)throw new Error("已取消");try{await Ce(r,v,O);return}catch(pe){P=pe,M<V&&await new Promise(fe=>setTimeout(fe,1e3*M))}}throw P||new Error(`分片 ${v} 失败`)},de=async()=>{var v;for(;$.length>0&&!((v=e.abortController)!=null&&v.signal.aborted);){const h=$.shift();if(h===void 0)break;await ce(h),D++,e.progress=Math.floor(D/w*90);const I=(Date.now()-s)/1e3;if(I>0){const P=Math.min(D*y,e.file.size)/1024/1024/I;e.speed=P.toFixed(1)+" MB/s"}}},ue=Array(Math.min(ie,w)).fill(null).map(()=>de());if(await Promise.all(ue),e.abortController.signal.aborted)throw new Error("已取消");e.status="merging",e.speed="合并中...",e.progress=95,await Fe(r,w),await ze(g.instanceId,r,e.path,g.currentPath),e.status="success",e.progress=100,e.speed="完成"}catch(a){a.message==="已取消"||(t=e.abortController)!=null&&t.signal.aborted?(e.status="pending",e.speed="已取消",e.progress=0):(e.status="error",e.errorMsg=a.message||"失败")}},re=e=>{var t;(t=l.value[e].abortController)==null||t.abort(),l.value.splice(e,1)},le=()=>{l.value=l.value.filter(e=>e.status!=="success")},ne=()=>U("update:visible",!1);return he(()=>l.value.forEach(e=>{var s;return(s=e.abortController)==null?void 0:s.abort()})),(e,s)=>{const t=R("t-button"),a=R("t-progress"),r=R("t-dialog");return n(),F(r,{visible:T.visible,header:"批量上传文件",width:"650px",footer:!1,onClose:ne},{default:d(()=>[i("input",{ref_key:"fileInputRef",ref:N,type:"file",multiple:"",style:{display:"none"},onChange:L},null,544),i("input",{ref_key:"folderInputRef",ref:j,type:"file",webkitdirectory:"",style:{display:"none"},onChange:L},null,544),i("div",je,[i("div",{class:me(["drop-zone",{active:z.value}]),onDragover:s[0]||(s[0]=B(o=>z.value=!0,["prevent"])),onDragleave:s[1]||(s[1]=B(o=>z.value=!1,["prevent"])),onDrop:B(se,["prevent"])},[c(p(Ie),{size:"40px",style:{color:"var(--td-brand-color)"}}),g.allowFolder?(n(),u("p",Ae,"拖入文件或文件夹")):m("",!0),g.allowFolder?m("",!0):(n(),u("p",Le,"拖入文件")),i("div",Se,[c(t,{variant:"outline",size:"small",onClick:W},{icon:d(()=>[c(p(K))]),default:d(()=>[s[2]||(s[2]=b(" 选择文件",-1))]),_:1}),g.allowFolder?(n(),F(t,{key:0,variant:"outline",size:"small",onClick:ee},{icon:d(()=>[c(p(Q))]),default:d(()=>[s[3]||(s[3]=b(" 选择文件夹",-1))]),_:1})):m("",!0)])],34),l.value.length>0?(n(),u("div",ke,[i("span",Ve,[b(" 队列: "+f(l.value.length)+" 个 | ",1),_.value?(n(),u("span",$e,"总进度 "+f(H.value)+"%",1)):m("",!0)]),i("div",Oe,[c(t,{theme:"primary",size:"small",disabled:!J.value||_.value,onClick:oe},{icon:d(()=>[c(p(Pe))]),default:d(()=>[b(" "+f(_.value?"上传中...":"开始上传"),1)]),_:1},8,["disabled"]),c(t,{variant:"text",size:"small",onClick:le},{icon:d(()=>[c(p(Me))]),default:d(()=>[s[4]||(s[4]=b(" 清空已完成",-1))]),_:1})])])):m("",!0),l.value.length>0?(n(),u("div",Ge,[(n(!0),u(ge,null,_e(l.value,(o,y)=>(n(),u("div",{key:o.id,class:"file-item"},[i("div",Ze,[(n(),F(ye(A(x(o.path)).icon),{style:be({color:A(x(o.path)).color})},null,8,["style"]))]),i("div",qe,[i("div",Ke,[i("div",{class:"name",title:x(o.path)},f(x(o.path)),9,Qe),i("div",Xe,[o.status==="error"?(n(),u("span",Ye,f(o.errorMsg),1)):(n(),u("span",He,f(o.speed),1)),i("span",Je,f((o.file.size/1024/1024).toFixed(2))+" MB",1)])]),E(o.path)?(n(),u("div",{key:0,class:"file-path",title:E(o.path)},[c(p(Q),{size:"10px"}),b(" "+f(E(o.path))+"/ ",1)],8,We)):m("",!0),i("div",es,[c(a,{percentage:o.progress,status:o.status==="error"?"error":o.status==="success"?"success":"active",size:"small",label:!1},null,8,["percentage","status"])])]),i("div",ss,[o.status!=="success"?(n(),F(t,{key:0,shape:"circle",variant:"text",size:"small",onClick:w=>re(y)},{default:d(()=>[c(p(Ee))]),_:1},8,["onClick"])):(n(),F(p(De),{key:1,style:{color:"var(--td-success-color)","font-size":"18px"}}))])]))),128))])):m("",!0)])]),_:1},8,["visible"])}}}),ns=xe(ts,[["__scopeId","data-v-a5440cac"]]);export{ns as F};
