import{D as se,F as y,K as S,aa as te,b1 as b,b2 as d,b0 as x,aY as n,a$ as i,aX as u,b6 as h,bh as I,aZ as oe,G as c,ap as p,ao as _,b5 as f,O as ae,b3 as le,b4 as re,a_ as ne}from"./index.BbdIPky0.js";import{i as ie,g as ce,h as de,E as ue,_ as pe}from"./index.AC7et5r1.js";import{aG as fe,X as j,at as A,aa as ve,aM as he,ai as me,a as ge,aL as _e,aI as ye,ae as be,aJ as we,aN as Ce}from"./tdesign-icons-vue-next.1welRF8W.js";import{M as L}from"./tdesign-vue-next.DAtQqNrG.js";const Fe={class:"uploader-container"},ze={key:0,class:"drop-text"},xe={key:1,class:"drop-text"},Ie={class:"drop-actions"},Pe={key:0,class:"queue-actions"},Me={class:"queue-info"},De={key:0},Ee={class:"btn-group"},Re={key:1,class:"file-list"},Ue={class:"file-icon-wrapper"},Ne={class:"file-content"},Te={class:"file-header"},Be=["title"],ke={class:"meta"},Se={key:0,class:"error"},je={key:1},Ae={class:"size"},Le=["title"],Oe={class:"progress-wrapper"},Ve={class:"file-action"},$e=se({__name:"FileUploader",props:{visible:{type:Boolean},instanceId:{},currentPath:{},allowFolder:{type:Boolean,default:!0}},emits:["update:visible","success"],setup(P,{emit:O}){const m=P,M=O,r=y([]),g=y(!1),w=y(!1),D=y(),E=y(),R=e=>{var t;const s=(t=e.split(".").pop())==null?void 0:t.toLowerCase();return["png","jpg","jpeg","gif","ico","webp"].includes(s||"")?{icon:_e,color:"var(--td-success-color)"}:["jar","zip","rar","7z","tar","gz"].includes(s||"")?{icon:ye,color:"#722ed1"}:["js","ts","py","java","c","cpp","cs","json","yml","yaml","xml","html","css","properties","conf","sh","bat"].includes(s||"")?{icon:be,color:"var(--td-warning-color)"}:["log","txt","md","lock"].includes(s||"")?{icon:we,color:"var(--td-gray-color-6)"}:["db","db-wal","dat"].includes(s||"")?{icon:Ce,color:"var(--td-gray-color-8)"}:{icon:j,color:"var(--td-brand-color)"}},C=e=>e.split("/").pop()||e,F=e=>{const s=e.lastIndexOf("/");return s!==-1?e.substring(0,s):""},V=S(()=>{if(r.value.length===0)return 0;const e=r.value.reduce((s,t)=>s+t.progress,0);return Math.floor(e/r.value.length)}),$=S(()=>r.value.some(e=>e.status==="pending"||e.status==="error")),G=()=>{var e;return(e=D.value)==null?void 0:e.click()},Z=()=>{var e;return(e=E.value)==null?void 0:e.click()},U=e=>{const s=e.target;if(s.files&&s.files.length>0){const a=Array.from(s.files).map(l=>({file:l,path:l.webkitRelativePath||l.name}));T(a)}s.value=""},q=async e=>{var l;w.value=!1;const s=(l=e.dataTransfer)==null?void 0:l.items;if(!s)return;const t=[],a=Array.from(s).map(o=>o.webkitGetAsEntry()).filter(o=>o!==null);for(const o of a)o&&await N(o,t);T(t)},N=async(e,s)=>{if(e.isFile){const t=await new Promise((l,o)=>e.file(l,o)),a=e.fullPath.startsWith("/")?e.fullPath.slice(1):e.fullPath;s.push({file:t,path:a})}else if(e.isDirectory)if(m.allowFolder){const t=e.createReader(),a=await K(t);for(const l of a)await N(l,s)}else L.error("此处不支持上传文件夹")},K=async e=>{let s=[];const t=async()=>{const a=await new Promise((l,o)=>e.readEntries(l,o));a.length>0&&(s=s.concat(a),await t())};return await t(),s},T=e=>{e.forEach(({file:s,path:t})=>{r.value.some(a=>a.path===t&&a.file.size===s.size&&a.status!=="error")||r.value.push({id:Math.random().toString(36).substring(2),file:s,path:t,status:"pending",progress:0,speed:""})})},Q=async()=>{if(g.value)return;g.value=!0;const e=3,s=r.value.filter(t=>t.status==="pending"||t.status==="error");for(let t=0;t<s.length;t+=e){const a=s.slice(t,t+e);await Promise.all(a.map(l=>X(l)))}g.value=!1,r.value.every(t=>t.status==="success")&&(L.success("上传完成"),M("success"))},X=async e=>{e.status="uploading",e.progress=0,e.abortController=new AbortController;const s=Date.now();try{const a=(await ie()).uploadId,l=2*1024*1024,o=Math.ceil(e.file.size/l);for(let v=0;v<o;v++){if(e.abortController.signal.aborted)throw new Error("已取消");const z=v*l,B=Math.min(e.file.size,z+l),W=e.file.slice(z,B);await ce(a,v,W),e.progress=Math.floor((v+1)/o*90);const k=(Date.now()-s)/1e3;if(k>0){const ee=B/1024/1024/k;e.speed=ee.toFixed(1)+" MB/s"}}e.status="merging",e.progress=95,await de(a,o),await ue(m.instanceId,a,e.path,m.currentPath),e.status="success",e.progress=100,e.speed="完成"}catch(t){t.message==="已取消"?(e.status="pending",e.speed="已取消"):(e.status="error",e.errorMsg=t.message||"失败")}},Y=e=>{var t;(t=r.value[e].abortController)==null||t.abort(),r.value.splice(e,1)},H=()=>{r.value=r.value.filter(e=>e.status!=="success")},J=()=>M("update:visible",!1);return te(()=>r.value.forEach(e=>{var s;return(s=e.abortController)==null?void 0:s.abort()})),(e,s)=>{const t=x("t-button"),a=x("t-progress"),l=x("t-dialog");return n(),b(l,{visible:P.visible,header:"批量上传文件",width:"650px",footer:!1,onClose:J},{default:d(()=>[i("input",{ref_key:"fileInputRef",ref:D,type:"file",multiple:"",style:{display:"none"},onChange:U},null,544),i("input",{ref_key:"folderInputRef",ref:E,type:"file",webkitdirectory:"",style:{display:"none"},onChange:U},null,544),i("div",Fe,[i("div",{class:oe(["drop-zone",{active:w.value}]),onDragover:s[0]||(s[0]=I(o=>w.value=!0,["prevent"])),onDragleave:s[1]||(s[1]=I(o=>w.value=!1,["prevent"])),onDrop:I(q,["prevent"])},[c(p(fe),{size:"40px",style:{color:"var(--td-brand-color)"}}),m.allowFolder?(n(),u("p",ze,"拖入文件或文件夹")):h("",!0),m.allowFolder?h("",!0):(n(),u("p",xe,"拖入文件")),i("div",Ie,[c(t,{variant:"outline",size:"small",onClick:G},{icon:d(()=>[c(p(j))]),default:d(()=>[s[2]||(s[2]=_(" 选择文件",-1))]),_:1}),m.allowFolder?(n(),b(t,{key:0,variant:"outline",size:"small",onClick:Z},{icon:d(()=>[c(p(A))]),default:d(()=>[s[3]||(s[3]=_(" 选择文件夹",-1))]),_:1})):h("",!0)])],34),r.value.length>0?(n(),u("div",Pe,[i("span",Me,[_(" 队列: "+f(r.value.length)+" 个 | ",1),g.value?(n(),u("span",De,"总进度 "+f(V.value)+"%",1)):h("",!0)]),i("div",Ee,[c(t,{theme:"primary",size:"small",disabled:!$.value||g.value,onClick:Q},{icon:d(()=>[c(p(ve))]),default:d(()=>[_(" "+f(g.value?"上传中...":"开始上传"),1)]),_:1},8,["disabled"]),c(t,{variant:"text",size:"small",onClick:H},{icon:d(()=>[c(p(he))]),default:d(()=>[s[4]||(s[4]=_(" 清空已完成",-1))]),_:1})])])):h("",!0),r.value.length>0?(n(),u("div",Re,[(n(!0),u(ae,null,le(r.value,(o,v)=>(n(),u("div",{key:o.id,class:"file-item"},[i("div",Ue,[(n(),b(re(R(C(o.path)).icon),{style:ne({color:R(C(o.path)).color})},null,8,["style"]))]),i("div",Ne,[i("div",Te,[i("div",{class:"name",title:C(o.path)},f(C(o.path)),9,Be),i("div",ke,[o.status==="error"?(n(),u("span",Se,f(o.errorMsg),1)):(n(),u("span",je,f(o.speed),1)),i("span",Ae,f((o.file.size/1024/1024).toFixed(2))+" MB",1)])]),F(o.path)?(n(),u("div",{key:0,class:"file-path",title:F(o.path)},[c(p(A),{size:"10px"}),_(" "+f(F(o.path))+"/ ",1)],8,Le)):h("",!0),i("div",Oe,[c(a,{percentage:o.progress,status:o.status==="error"?"error":o.status==="success"?"success":"active",size:"small",label:!1},null,8,["percentage","status"])])]),i("div",Ve,[o.status!=="success"?(n(),b(t,{key:0,shape:"circle",variant:"text",size:"small",onClick:z=>Y(v)},{default:d(()=>[c(p(me))]),_:1},8,["onClick"])):(n(),b(p(ge),{key:1,style:{color:"var(--td-success-color)","font-size":"18px"}}))])]))),128))])):h("",!0)])]),_:1},8,["visible"])}}}),Qe=pe($e,[["__scopeId","data-v-df2f7884"]]);export{Qe as F};
