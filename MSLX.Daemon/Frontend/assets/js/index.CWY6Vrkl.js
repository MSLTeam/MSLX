import{a as T,u as U}from"./vue-router.BSuyFzNa.js";import{L as V}from"./Header.DX5u8QmL.js";import{u as z,T as F,r as b,c as y,_ as N}from"./index.Cr1BKOIM.js";import{a as $,e as q}from"./tdesign-icons-vue-next.ELWhrgRC.js";import{M as A}from"./tdesign-vue-next.4sGFOLeu.js";import{l as D,o as E,aZ as w,aU as u,aV as d,j as r,aY as s,b2 as n,J as v,a$ as x,G as S,r as l}from"./index.DuVfB4dr.js";import"./pinia.K9HejpEf.js";import"./pinia-plugin-persistedstate_2eabddac918ad8d0cf74e67f4601f4c8.n2tMOXAx.js";import"./tvision-color.Cy78gTfV.js";import"./chroma-js.DO2ptVd8.js";import"./core-js-pure.DbDavgKW.js";import"./bezier-easing.D5A5epFU.js";import"./lodash.CpoxsuHF.js";import"./axios.B9ygI19o.js";import"./qs.B2qFNmGA.js";import"./side-channel.BIlHSgJq.js";import"./es-errors.CFxpeikN.js";import"./object-inspect.CWmL7r7A.js";import"./side-channel-list.DZ_HK50j.js";import"./side-channel-map.DDbmCn0b.js";import"./get-intrinsic.DL3knghB.js";import"./es-object-atoms.Ditt1eQ6.js";import"./math-intrinsics.Cv-yPkyD.js";import"./gopd.fcd2-aIC.js";import"./es-define-property.bDCdrV83.js";import"./has-symbols.BaUvM3gb.js";import"./get-proto.Cbri-GHQ.js";import"./dunder-proto.q7lw_6_J.js";import"./call-bind-apply-helpers.BxcZtPLH.js";import"./function-bind.BbkWVFrm.js";import"./hasown.ckq0ukzO.js";import"./call-bound.Cne7q6oT.js";import"./side-channel-weakmap.BTkyjVO1.js";import"./nprogress.COlaCQ7y.js";import"./crelt.C8TCjufn.js";import"./style-mod.Bc2inJdb.js";import"./w3c-keyname.Vcq4gwWv.js";import"./lodash-es.sbUBen0f.js";import"./mitt.DJ65BbbF.js";import"./sortablejs.C83syoBY.js";const O={class:"login-wrapper"},R={class:"login-panel"},Y={class:"login-container"},j={class:"callback-content"},G={key:0,class:"status-box"},H={class:"loading-icon-wrapper"},J={class:"tip-text"},P={key:1,class:"status-box success"},X={class:"desc"},Z={class:"sub-desc"},K={class:"btn-group"},Q={key:2,class:"status-box error"},W={class:"error-msg-box"},tt={class:"btn-group"},st={class:"copyright"},ot=D({__name:"index",setup(et){const k=T(),C=U(),p=z(),a=l("loading"),m=l("正在验证身份..."),i=l(""),g=l(""),_=l(3),M=async()=>{const{code:o,state:t,mode:e}=k.query;if(!o||!t){a.value="error",i.value="无效的回调参数，缺少 Code 或 State。";return}const c=localStorage.getItem("oauth_state");if(localStorage.removeItem("oauth_state"),t!==c){a.value="error",i.value="安全校验失败 (State Mismatch)，请求可能被篡改。";return}try{if(e==="login")await I(o);else if(e==="bind")await L(o);else throw new Error("未知的操作模式")}catch(f){a.value="error",i.value=f.message||"处理请求时发生未知错误"}},I=async o=>{var t;m.value="正在登录 MSLX...";try{const e=await b.post({url:"/api/auth/oauth/login",data:{code:o}});await p.loginByOAuth(e),a.value="success",g.value=`欢迎回来，${p.userInfo.name||((t=e.data.userInfo)==null?void 0:t.name)}`,h("/dashboard/base")}catch(e){a.value="error",i.value=e.message}},L=async o=>{m.value="正在绑定 MSL 账号...";try{await b.post({url:"/api/auth/oauth/bind",data:{code:o}}),a.value="success",g.value="账号绑定成功！",await p.getUserInfo(),h("/settings")}catch(t){A.error(t.message)}},h=o=>{const t=setInterval(()=>{_.value--,_.value<=0&&(clearInterval(t),y(o))},1e3)},B=()=>{y("/login")};return E(()=>{M()}),(o,t)=>{const e=w("t-loading"),c=w("t-button");return u(),d("div",O,[r(V,{class:"login-header-fixed"}),s("div",R,[s("div",Y,[t[5]||(t[5]=s("div",{class:"title-container"},[s("h1",{style:{"margin-bottom":"10px"},class:"title"},"MSL 统一身份认证")],-1)),s("div",j,[a.value==="loading"?(u(),d("div",G,[s("div",H,[r(e,{size:"large"})]),s("p",J,n(m.value),1)])):a.value==="success"?(u(),d("div",P,[r(v($),{class:"icon-success"}),t[2]||(t[2]=s("h2",{class:"status-title"},"操作成功",-1)),s("p",X,n(g.value),1),s("p",Z,n(_.value)+" 秒后自动跳转...",1),s("div",K,[r(c,{block:"",size:"large",class:"login-btn",onClick:t[0]||(t[0]=f=>v(C).push("/dashboard/base"))},{default:x(()=>[...t[1]||(t[1]=[S(" 立即进入 ",-1)])]),_:1})])])):(u(),d("div",Q,[r(v(q),{class:"icon-error"}),t[4]||(t[4]=s("h2",{class:"status-title"},"操作失败",-1)),s("div",W,n(i.value),1),s("div",tt,[r(c,{block:"",size:"large",class:"login-btn",onClick:B},{default:x(()=>[...t[3]||(t[3]=[S(" 返回登录页 ",-1)])]),_:1})])]))]),s("footer",st,"Copyright @ 2021-"+n(new Date().getFullYear())+" MSLTeam",1)])]),r(F,{class:"tdesign-setting-outside"})])}}}),jt=N(ot,[["__scopeId","data-v-fa1e4e34"]]);export{jt as default};
