import{a as q}from"./vue-router.BSuyFzNa.js";import{u as Z,_ as P,l as K,s as O}from"./index.DKJwv0BD.js";import{l as V,w as Y,o as X,n as Q,f as ee,aV as R,aY as o,b2 as b,r as x,bf as te,bg as ne,b7 as ae,b8 as oe,aU as w,j as c,a$ as m,aZ as U,aW as ie,G as v,a_ as A,J as g,F as se,b0 as re,b3 as z}from"./index.DuVfB4dr.js";import{c as I}from"./ansi-colors.DNitgexK.js";import{c as D}from"./clipboard.B82L0Ftg.js";import{ad as le,a3 as ce,U as de,P as ue,aa as me,ab as fe,ae as pe,a6 as G,af as H}from"./tdesign-icons-vue-next.BalHEYKK.js";import{F as ve}from"./FileEditor.DlHx4kl1.js";import{u as ge,c as he,d as J}from"./frp.BiqVjG4L.js";import{M as S,D as be}from"./tdesign-vue-next.Csn1Y9JM.js";import"./pinia.K9HejpEf.js";import"./pinia-plugin-persistedstate_2eabddac918ad8d0cf74e67f4601f4c8.n2tMOXAx.js";import"./tvision-color.Cy78gTfV.js";import"./chroma-js.DO2ptVd8.js";import"./core-js-pure.DbDavgKW.js";import"./bezier-easing.D5A5epFU.js";import"./lodash.CpoxsuHF.js";import"./axios.B9ygI19o.js";import"./qs.CsZETzAf.js";import"./side-channel.gyxQHTce.js";import"./es-errors.CFxpeikN.js";import"./object-inspect.CWmL7r7A.js";import"./side-channel-list.DZ_HK50j.js";import"./side-channel-map.Ujj6CYbr.js";import"./get-intrinsic.DZF4l_-S.js";import"./es-object-atoms.Ditt1eQ6.js";import"./math-intrinsics.Cv-yPkyD.js";import"./gopd.fcd2-aIC.js";import"./es-define-property.bDCdrV83.js";import"./has-symbols.BaUvM3gb.js";import"./get-proto.GRuZvLsk.js";import"./dunder-proto.BfGlLUzx.js";import"./call-bind-apply-helpers.DPbVMkjK.js";import"./function-bind.CHqF18-c.js";import"./hasown.B1sN64jK.js";import"./call-bound.DTRAK3sj.js";import"./side-channel-weakmap.D0YmY7JX.js";import"./nprogress.COlaCQ7y.js";import"./crelt.C8TCjufn.js";import"./style-mod.Bc2inJdb.js";import"./w3c-keyname.Vcq4gwWv.js";import"./lodash-es.sbUBen0f.js";import"./mitt.DJ65BbbF.js";import"./sortablejs.C83syoBY.js";import"./vue-codemirror.am87IH_v.js";import"./codemirror.lvVLeZ7G.js";import"./prettier._FpaQKPv.js";const we={class:"terminal-header"},ye={class:"tab-title"},Be=V({__name:"ConsoleTerminal",props:{frpId:{}},emits:["update"],setup(i,{expose:$,emit:n}){const l=i,y=n,C=Z(),B=x(null),a=x(null);let e=null,k=null,_=null,f=null,u=null;const F={dark:{background:"transparent",foreground:"#cccccc",cursor:"transparent",selectionBackground:"#264f78",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#e5e5e5"},light:{background:"transparent",foreground:"#333333",cursor:"transparent",selectionBackground:"#add6ff",black:"#000000",red:"#cd3131",green:"#00bc79",yellow:"#9d9d10",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#e5e5e5"}};I.enabled=!0;const N=t=>t?(t=t.replace(/^(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}(\.\d{3})?)/,r=>I.gray(r)),t=t.replace(/\[I\]/g,I.green("[I]")),t=t.replace(/\[W\]/g,I.yellow("[W]")),t=t.replace(/\[E\]/g,I.red("[E]")),t=t.replace(/(success)/gi,r=>I.bold.green(r)),t=t.replace(/(start|starting)/gi,r=>I.blue(r)),t=t.replace(/(failed|error)/gi,r=>I.bgRed.white(` ${r} `)),t=t.replace(/(:\d{4,5})/g,r=>I.cyan(r)),t=t.replace(/(\[[0-9a-f]{8,}\])/g,r=>I.magenta(r)),t):"",M=()=>{if(!a.value||!B.value)return;if(e){e.clear(),E();return}const t=document.documentElement.getAttribute("theme-mode")==="dark";e=new te.Terminal({cursorBlink:!1,cursorStyle:"bar",fontSize:13,fontFamily:'Menlo, Monaco, "Courier New", monospace',lineHeight:1.4,theme:t?F.dark:F.light,allowTransparency:!0,disableStdin:!0,convertEol:!0}),k=new ne.FitAddon,e.loadAddon(k),e.open(a.value);const r=()=>{if(a.value&&a.value.clientWidth>0&&a.value.clientHeight>0)try{k==null||k.fit()}catch(T){console.warn(T)}};_=new ResizeObserver(()=>window.requestAnimationFrame(r)),_.observe(B.value),setTimeout(r,100),E()},W=()=>{if(!e)return;const t=document.documentElement.getAttribute("theme-mode")==="dark";e.options.theme=t?F.dark:F.light},E=()=>{e==null||e.writeln("\x1B[1;34m[System]\x1B[0m 正在初始化Frp控制台 ..."),e==null||e.writeln(`\x1B[1;34m[System]\x1B[0m ID: ${l.frpId} | 状态: \x1B[32m已就绪！\x1B[0m`)},L=async()=>{if(u)try{await u.stop(),u=null}catch(t){console.error(t)}},s=async()=>{if(await L(),!l.frpId)return;const{baseUrl:t,token:r}=C,T=new URL("/api/hubs/frpLogsHub",t||window.location.origin);r&&T.searchParams.append("x-user-token",r),console.log(T.toString()),u=new ae().withUrl(T.toString(),{withCredentials:!1}).configureLogging(oe.Warning).withAutomaticReconnect([0,2e3,5e3,1e4,3e4]).build(),u.on("ReceiveLog",h=>{e==null||e.writeln(N(h)),h.includes("[MSLX]")&&setTimeout(()=>{y("update")},2e3)}),u.onreconnecting(h=>{e==null||e.writeln("\x1B[1;33m[System] 检测到连接中断，正在尝试重连...\x1B[0m"),console.warn("SignalR Reconnecting:",h)}),u.onreconnected(async()=>{e==null||e.writeln("\x1B[1;32m[System] 网络已恢复，重新连接日志服务...\x1B[0m");try{await(u==null?void 0:u.invoke("JoinGroup",l.frpId)),e==null||e.writeln("\x1B[1;32m[System] 日志服务成功重新连接！\x1B[0m")}catch(h){e==null||e.writeln(`\x1B[1;31m[Error] 重新连接日志服务失败: ${h.message}\x1B[0m`)}}),u.onclose(h=>{h&&(e==null||e.writeln(`\x1B[1;31m[System] 日志服务连接已断开: ${h.message}\x1B[0m`),e==null||e.writeln("\x1B[1;31m[System] 请刷新页面或检查网络连接。\x1B[0m"))});try{await u.start(),e==null||e.writeln("\x1B[1;32m[System] 成功连接到Frpc日志服务\x1B[0m"),await u.invoke("JoinGroup",l.frpId)}catch(h){e==null||e.writeln(`\x1B[1;31m[Error] 连接失败: ${h.message}\x1B[0m`)}};return $({writeln:t=>e==null?void 0:e.writeln(t),clear:()=>{e==null||e.clear(),E()}}),Y(()=>l.frpId,async t=>{t&&(M(),await s())}),X(async()=>{await Q(),M(),f=new MutationObserver(W),f.observe(document.documentElement,{attributes:!0,attributeFilter:["theme-mode"]}),l.frpId&&await s()}),ee(async()=>{f==null||f.disconnect(),await L(),e==null||e.dispose(),_==null||_.disconnect()}),(t,r)=>(w(),R("div",{ref_key:"terminalWrapper",ref:B,class:"terminal-wrapper"},[o("div",we,[r[0]||(r[0]=o("div",{class:"dots"},[o("span",{class:"dot red"}),o("span",{class:"dot yellow"}),o("span",{class:"dot green"})],-1)),o("div",ye,"MSLX - Frp 控制台 | "+b(i.frpId),1)]),o("div",{ref_key:"terminalBody",ref:a,class:"terminal-body"},null,512)],512))}}),ke=P(Be,[["__scopeId","data-v-c605b515"]]),xe={class:"sidebar-content"},Ce={class:"control-header"},Ie={class:"control-actions"},$e={class:"action-row"},_e={class:"info-list"},Se={class:"info-item"},Re={class:"label"},Te={class:"value"},Fe={key:0,class:"proxy-header"},Ee={class:"info-item"},Ae={class:"label"},Me=["onClick"],Le={class:"info-item"},Ue={class:"label"},Ne={class:"value highlight"},We={class:"info-item"},De={class:"label"},Pe=["onClick"],Ve={key:1,class:"info-item"},ze={class:"label"},Ge=["onClick"],He={class:"info-item"},Je={class:"label"},Ye={class:"value"},Xe={key:1,class:"info-item empty-state"},je={class:"value"},qe=V({__name:"ControlPanel",props:{frpId:{},isRunning:{type:Boolean},loading:{type:Boolean},tunnelInfo:{}},emits:["start","stop","clear-log","edit-config"],setup(i){return($,n)=>{const l=U("t-tag"),y=U("t-button"),C=U("t-card"),B=U("t-tooltip");return w(),R("div",xe,[c(C,{class:"control-card",bordered:!1},{default:m(()=>[o("div",Ce,[o("div",{class:ie(["status-indicator",{running:i.isRunning}])},[n[4]||(n[4]=o("span",{class:"pulse"},null,-1)),v(b(i.isRunning?"Running":"Stopped"),1)],2),c(l,{theme:i.isRunning?"success":"default",variant:"light",shape:"round"},{default:m(()=>[v(b(i.isRunning?"正常运行":"未运行"),1)]),_:1},8,["theme"])]),o("div",Ie,[i.isRunning?(w(),A(y,{key:1,theme:"danger",size:"large",block:"",loading:i.loading,onClick:n[1]||(n[1]=a=>$.$emit("stop"))},{icon:m(()=>[c(g(ce))]),default:m(()=>[n[6]||(n[6]=v("停止服务 ",-1))]),_:1},8,["loading"])):(w(),A(y,{key:0,theme:"primary",size:"large",block:"",loading:i.loading,onClick:n[0]||(n[0]=a=>$.$emit("start"))},{icon:m(()=>[c(g(le))]),default:m(()=>[n[5]||(n[5]=v("启动服务 ",-1))]),_:1},8,["loading"])),o("div",$e,[c(y,{class:"glass-btn",variant:"outline",theme:"warning",onClick:n[2]||(n[2]=a=>$.$emit("clear-log"))},{icon:m(()=>[c(g(de))]),default:m(()=>[n[7]||(n[7]=v("清空日志 ",-1))]),_:1}),c(y,{variant:"outline",theme:"default",onClick:n[3]||(n[3]=a=>$.$emit("edit-config"))},{icon:m(()=>[c(g(ue))]),default:m(()=>[n[8]||(n[8]=v("配置文件 ",-1))]),_:1})])])]),_:1}),c(C,{title:"隧道概览",class:"info-card",bordered:!1},{actions:m(()=>[i.tunnelInfo&&i.tunnelInfo.proxies&&i.tunnelInfo.proxies.length>0&&i.tunnelInfo.proxies.some(a=>a.type==="xtcp")?(w(),A(l,{key:0,variant:"light-outline",theme:"primary"},{default:m(()=>[...n[9]||(n[9]=[v("联机房间 - 房主",-1)])]),_:1})):i.tunnelInfo&&i.tunnelInfo.proxies&&i.tunnelInfo.proxies.length>0&&i.tunnelInfo.proxies.some(a=>a.type==="xtcp - Visitors")?(w(),A(l,{key:1,variant:"light-outline",theme:"primary"},{default:m(()=>[...n[10]||(n[10]=[v("联机房间 - 访客",-1)])]),_:1})):(w(),A(y,{key:2,shape:"circle",variant:"text"},{default:m(()=>[c(g(H))]),_:1}))]),default:m(()=>[o("div",_e,[o("div",Se,[o("div",Re,[c(g(me)),n[11]||(n[11]=v(" 隧道实例 ID",-1))]),o("div",Te,"#"+b(i.frpId),1)]),i.tunnelInfo&&i.tunnelInfo.proxies&&i.tunnelInfo.proxies.length>0?(w(!0),R(se,{key:0},re(i.tunnelInfo.proxies,(a,e)=>(w(),R("div",{key:e,class:"proxy-group"},[i.tunnelInfo.proxies.length>1?(w(),R("div",Fe,"配置 #"+b(e+1),1)):z("",!0),o("div",Ee,[o("div",Ae,[c(g(fe)),v(" "+b(a.type.includes("xtcp")?"房间号":"隧道名称"),1)]),c(B,{content:a.proxyName,placement:"top","show-arrow":"","destroy-on-close":""},{default:m(()=>[o("div",{onClick:k=>g(D)(a.proxyName,!0,`${a.type.includes("xtcp")?"房间号":"隧道名称"}已复制！`),class:"value remote-addr pointer"},b(a.proxyName),9,Me)]),_:2},1032,["content"])]),o("div",Le,[o("div",Ue,[c(g(pe)),n[12]||(n[12]=v(" 协议类型",-1))]),o("div",Ne,b(a.type.toUpperCase()),1)]),o("div",We,[o("div",De,[c(g(G)),v(" "+b(a.type.includes("xtcp")?"房间密钥":"连接地址"),1)]),c(B,{content:a.remoteAddressMain,placement:"top","show-arrow":"","destroy-on-close":""},{default:m(()=>[o("div",{class:"value remote-addr pointer",onClick:k=>g(D)(a.remoteAddressMain,!0,`${a.type.includes("xtcp")?"房间密钥":"连接地址"}已复制！`)},b(a.remoteAddressMain||"获取中..."),9,Pe)]),_:2},1032,["content"])]),a.remoteAddressBackup&&a.remoteAddressBackup!==a.remoteAddressMain?(w(),R("div",Ve,[o("div",ze,[c(g(G)),n[13]||(n[13]=v(" 备用地址",-1))]),c(B,{content:a.remoteAddressBackup,placement:"top","show-arrow":"","destroy-on-close":""},{default:m(()=>[o("div",{class:"value remote-addr pointer",onClick:k=>g(D)(a.remoteAddressBackup,!0,"备用连接地址已复制！")},b(a.remoteAddressBackup),9,Ge)]),_:2},1032,["content"])])):z("",!0),o("div",He,[o("div",Je,[c(g(H)),n[14]||(n[14]=v(" 本地地址",-1))]),o("div",Ye,b(a.localAddress),1)])]))),128)):(w(),R("div",Xe,[n[15]||(n[15]=o("div",{class:"label"},"状态",-1)),o("div",je,b(i.loading?"正在加载配置...":"暂无详细信息"),1)]))])]),_:1})])}}}),Ze=P(qe,[["__scopeId","data-v-3a2669c8"]]),Ke={class:"console-page"},Oe={class:"layout-container"},Qe={class:"main-terminal-area"},et={class:"sidebar-area"},tt=V({__name:"index",setup(i){const $=ge(),n=q(),l=x(parseInt(n.params.frpId)||0),y=x(!1),C=x(!1),B=x(null),a=x(!1),e=x(""),k=x(""),_=x(!1),f=x(null);async function u(){var s;if(l.value)try{B.value=await he(l.value),y.value=B.value.isRunning,await $.getTunnels()}catch(d){console.error("获取隧道信息失败",d),(s=f.value)==null||s.writeln(`\x1B[1;31m[Error] 获取隧道信息失败: ${d}\x1B[0m`)}}const F=async()=>{var s,d;C.value=!0;try{(s=f.value)==null||s.writeln("\x1B[1;32m[System] 正在发送启动指令...\x1B[0m"),await J("start",l.value),y.value=!0,S.success("启动指令已发送"),setTimeout(u,1500)}catch(p){(d=f.value)==null||d.writeln(`\x1B[1;31m[Error] Frpc启动失败: ${p.message}\x1B[0m`)}finally{C.value=!1}},N=async()=>{var s,d;C.value=!0;try{(s=f.value)==null||s.writeln("\x1B[1;32m[System] 正在发送停止指令...\x1B[0m"),await J("stop",l.value),y.value=!1,S.warning("停止指令已发送"),setTimeout(u,1e3)}catch(p){(d=f.value)==null||d.writeln(`\x1B[1;31m[Error] Frpc停止失败: ${p.message}\x1B[0m`)}finally{C.value=!1}},M=()=>{var s;(s=f.value)==null||s.clear()},W=()=>{const s=be.confirm({header:"警告",body:`直接编辑配置文件可能会导致服务无法启动或异常。正常情况在线服务商提供的配置文件也不能修改。请确保您了解配置文件的格式和内容。

是否继续？`,theme:"warning",onConfirm:async()=>{s.hide(),await E()}})},E=async()=>{var d;const s=S.loading("正在读取配置文件...");try{let p="toml";const t=$.frpList.find(j=>j.id===l.value);t&&t.configType&&(p=t.configType.toLowerCase());const r=`frpc.${p}`,T=`${l.value}/${r}`,h=await K(0,T);e.value=r,k.value=h,a.value=!0,S.close(s)}catch(p){S.close(s),S.error("读取配置文件失败: "+p.message),(d=f.value)==null||d.writeln(`\x1B[1;31m[Error] 读取配置文件失败: ${p.message}\x1B[0m`)}},L=async s=>{var d,p;_.value=!0;try{const t=`${l.value}/${e.value}`;await O(0,t,s),S.success("配置文件保存成功"),a.value=!1,(d=f.value)==null||d.writeln("\x1B[1;32m[System] 配置文件已更新，请重启服务以生效。\x1B[0m")}catch(t){S.error("保存失败"),(p=f.value)==null||p.writeln(`\x1B[1;31m[Error] 保存失败: ${t.message}\x1B[0m`)}finally{_.value=!1}};return Y(()=>n.params.frpId,async s=>{n.name==="FrpConsole"&&s&&(l.value=parseInt(s),await u())}),X(()=>{l.value&&u()}),(s,d)=>(w(),R("div",Ke,[o("div",Oe,[o("div",Qe,[c(ke,{ref_key:"terminalRef",ref:f,"frp-id":l.value,onUpdate:d[0]||(d[0]=p=>u())},null,8,["frp-id"])]),o("div",et,[c(Ze,{"frp-id":l.value,"is-running":y.value,loading:C.value,"tunnel-info":B.value,onStart:F,onStop:N,onClearLog:M,onEditConfig:W},null,8,["frp-id","is-running","loading","tunnel-info"])])]),c(ve,{visible:a.value,"onUpdate:visible":d[1]||(d[1]=p=>a.value=p),"file-name":e.value,content:k.value,loading:_.value,onSave:L},null,8,["visible","file-name","content","loading"])]))}}),jt=P(tt,[["__scopeId","data-v-824a9275"]]);export{jt as default};
