import{l as _e,f as ye,a_ as z,a$ as p,r as b,aZ as A,aU as n,aY as i,be as L,aW as be,j as u,J as v,aV as f,b3 as g,G as w,b2 as h,F as we,b0 as Ce,c as Y,b1 as Fe,aX as ze}from"./index.DuVfB4dr.js";import{i as xe,h as Pe,j as Ie,F as Me,_ as Ee}from"./index.C0RiS9Sp.js";import{aG as Re,X as H,at as K,ad as Ue,aM as De,aj as Be,a as Ne,aL as Te,aI as je,af as Ae,aJ as Le,aN as Se}from"./tdesign-icons-vue-next.BalHEYKK.js";import{M as ee}from"./tdesign-vue-next.Csn1Y9JM.js";const ke={class:"uploader-container"},Ve={key:0,class:"drop-text"},$e={key:1,class:"drop-text"},Ge={class:"drop-actions"},Oe={key:0,class:"queue-actions"},Ze={class:"queue-info"},qe={key:0},Je={class:"btn-group"},Qe={key:1,class:"file-list"},We={class:"file-icon-wrapper"},Xe={class:"file-content"},Ye={class:"file-header"},He=["title"],Ke={class:"meta"},es={key:0,class:"error"},ss={key:1},ts={class:"size"},os=["title"],as={class:"progress-wrapper"},rs={class:"file-action"},ls=_e({__name:"FileUploader",props:{visible:{type:Boolean},instanceId:{},currentPath:{},allowFolder:{type:Boolean,default:!0}},emits:["update:visible","success"],setup(S,{emit:se}){const m=S,k=se,r=b([]),_=b(!1),D=b(!1),x=b(!1),V=b(),$=b(),G=e=>{var t;const s=(t=e.split(".").pop())==null?void 0:t.toLowerCase();return["png","jpg","jpeg","gif","ico","webp"].includes(s||"")?{icon:Te,color:"var(--td-success-color)"}:["jar","zip","rar","7z","tar","gz"].includes(s||"")?{icon:je,color:"#722ed1"}:["js","ts","py","java","c","cpp","cs","json","yml","yaml","xml","html","css","properties","conf","sh","bat"].includes(s||"")?{icon:Ae,color:"var(--td-warning-color)"}:["log","txt","md","lock"].includes(s||"")?{icon:Le,color:"var(--td-gray-color-6)"}:["db","db-wal","dat"].includes(s||"")?{icon:Se,color:"var(--td-gray-color-8)"}:{icon:H,color:"var(--td-brand-color)"}},P=e=>e.split("/").pop()||e,B=e=>{const s=e.lastIndexOf("/");return s!==-1?e.substring(0,s):""},te=Y(()=>{if(r.value.length===0)return 0;const e=r.value.reduce((s,t)=>s+t.progress,0);return Math.floor(e/r.value.length)}),oe=Y(()=>r.value.some(e=>e.status==="pending"||e.status==="error")),ae=()=>{var e;return(e=V.value)==null?void 0:e.click()},re=()=>{var e;return(e=$.value)==null?void 0:e.click()},O=e=>{const s=e.target;if(s.files&&s.files.length>0){const l=Array.from(s.files).map(a=>({file:a,path:a.webkitRelativePath||a.name}));q(l)}s.value=""},le=async e=>{var a;x.value=!1;const s=(a=e.dataTransfer)==null?void 0:a.items;if(!s)return;const t=[],l=Array.from(s).map(o=>o.webkitGetAsEntry()).filter(o=>o!==null);for(const o of l)o&&await Z(o,t);q(t)},Z=async(e,s)=>{if(e.isFile){const t=await new Promise((a,o)=>e.file(a,o)),l=e.fullPath.startsWith("/")?e.fullPath.slice(1):e.fullPath;s.push({file:t,path:l})}else if(e.isDirectory)if(m.allowFolder){const t=e.createReader(),l=await ne(t);for(const a of l)await Z(a,s)}else ee.error("此处不支持上传文件夹")},ne=async e=>{let s=[];const t=async()=>{const l=await new Promise((a,o)=>e.readEntries(a,o));l.length>0&&(s=s.concat(l),await t())};return await t(),s},q=e=>{e.forEach(({file:s,path:t})=>{r.value.some(l=>l.path===t&&l.file.size===s.size&&l.status!=="error")||r.value.push({id:Math.random().toString(36).substring(2),file:s,path:t,status:"pending",progress:0,speed:""})})},ie=async()=>{if(_.value)return;_.value=!0,D.value=!1;const e=3,s=r.value.filter(t=>t.status==="pending"||t.status==="error");for(let t=0;t<s.length&&!(D.value&&r.value.length===0);t+=e){const a=s.slice(t,t+e).filter(o=>r.value.some(I=>I.id===o.id));a.length>0&&await Promise.all(a.map(o=>ce(o)))}_.value=!1,!D.value&&r.value.length>0&&r.value.every(t=>t.status==="success")&&(ee.success("上传完成"),k("success"))},ce=async e=>{var l;e.status="uploading",e.progress=0,e.abortController=new AbortController;const s=Date.now();let t=0;try{const o=(await xe()).uploadId,M=e.file.size>200*1024*1024?50*1024*1024:10*1024*1024,N=Math.ceil(e.file.size/M),fe=4,J=5,Q=Array.from({length:N},(c,d)=>d),E=new Map,T=()=>{const c=Date.now();if(c-t<100)return;t=c;const d=Array.from(E.values()).reduce((y,R)=>y+R,0),j=Math.min(d/e.file.size*95,95);e.progress=Number(j.toFixed(1));const C=(c-s)/1e3;if(C>0){const y=d/1024/1024/C;e.speed=y.toFixed(1)+" MB/s"}},ve=async c=>{var R,W,X;if((R=e.abortController)!=null&&R.signal.aborted)throw new Error("已取消");const d=c*M,j=Math.min(e.file.size,d+M),C=e.file.slice(d,j);let y;for(let U=1;U<=J;U++){if((W=e.abortController)!=null&&W.signal.aborted)throw new Error("已取消");try{await Pe(o,c,C,F=>{F&&F.loaded&&(E.set(c,F.loaded),T())},(X=e.abortController)==null?void 0:X.signal),E.set(c,C.size),T();return}catch(F){y=F,U<J&&(E.set(c,0),T(),await new Promise(me=>setTimeout(me,1e3*U)))}}throw y||new Error(`分片 ${c} 失败`)},he=async()=>{var c;for(;Q.length>0&&!((c=e.abortController)!=null&&c.signal.aborted);){const d=Q.shift();if(d===void 0)break;await ve(d)}},ge=Array(Math.min(fe,N)).fill(null).map(()=>he());if(await Promise.all(ge),e.abortController.signal.aborted)throw new Error("已取消");e.status="merging",e.speed="合并中...",e.progress=98,await Ie(o,N),await Me(m.instanceId,o,e.path,m.currentPath),e.status="success",e.progress=100,e.speed="完成"}catch(a){a.message==="已取消"||(l=e.abortController)!=null&&l.signal.aborted?(e.status="pending",e.speed="已取消",e.progress=0):(e.status="error",e.errorMsg=a.message||"失败")}},ue=e=>{var t;(t=r.value[e].abortController)==null||t.abort(),r.value.splice(e,1)},de=()=>{r.value=r.value.filter(e=>e.status!=="success")},pe=()=>k("update:visible",!1);return ye(()=>r.value.forEach(e=>{var s;return(s=e.abortController)==null?void 0:s.abort()})),(e,s)=>{const t=A("t-button"),l=A("t-progress"),a=A("t-dialog");return n(),z(a,{visible:S.visible,header:"批量上传文件",width:"650px",footer:!1,onClose:pe},{default:p(()=>[i("input",{ref_key:"fileInputRef",ref:V,type:"file",multiple:"",style:{display:"none"},onChange:O},null,544),i("input",{ref_key:"folderInputRef",ref:$,type:"file",webkitdirectory:"",style:{display:"none"},onChange:O},null,544),i("div",ke,[i("div",{class:be(["drop-zone",{active:x.value}]),onDragover:s[0]||(s[0]=L(o=>x.value=!0,["prevent"])),onDragleave:s[1]||(s[1]=L(o=>x.value=!1,["prevent"])),onDrop:L(le,["prevent"])},[u(v(Re),{size:"40px",style:{color:"var(--td-brand-color)"}}),m.allowFolder?(n(),f("p",Ve,"拖入文件或文件夹")):g("",!0),m.allowFolder?g("",!0):(n(),f("p",$e,"拖入文件")),i("div",Ge,[u(t,{variant:"outline",size:"small",onClick:ae},{icon:p(()=>[u(v(H))]),default:p(()=>[s[2]||(s[2]=w(" 选择文件",-1))]),_:1}),m.allowFolder?(n(),z(t,{key:0,variant:"outline",size:"small",onClick:re},{icon:p(()=>[u(v(K))]),default:p(()=>[s[3]||(s[3]=w(" 选择文件夹",-1))]),_:1})):g("",!0)])],34),r.value.length>0?(n(),f("div",Oe,[i("span",Ze,[w(" 队列: "+h(r.value.length)+" 个 | ",1),_.value?(n(),f("span",qe,"总进度 "+h(te.value)+"%",1)):g("",!0)]),i("div",Je,[u(t,{theme:"primary",size:"small",disabled:!oe.value||_.value,onClick:ie},{icon:p(()=>[u(v(Ue))]),default:p(()=>[w(" "+h(_.value?"上传中...":"开始上传"),1)]),_:1},8,["disabled"]),u(t,{variant:"text",size:"small",onClick:de},{icon:p(()=>[u(v(De))]),default:p(()=>[s[4]||(s[4]=w(" 清空已完成",-1))]),_:1})])])):g("",!0),r.value.length>0?(n(),f("div",Qe,[(n(!0),f(we,null,Ce(r.value,(o,I)=>(n(),f("div",{key:o.id,class:"file-item"},[i("div",We,[(n(),z(Fe(G(P(o.path)).icon),{style:ze({color:G(P(o.path)).color})},null,8,["style"]))]),i("div",Xe,[i("div",Ye,[i("div",{class:"name",title:P(o.path)},h(P(o.path)),9,He),i("div",Ke,[o.status==="error"?(n(),f("span",es,h(o.errorMsg),1)):(n(),f("span",ss,h(o.speed),1)),i("span",ts,h((o.file.size/1024/1024).toFixed(2))+" MB",1)])]),B(o.path)?(n(),f("div",{key:0,class:"file-path",title:B(o.path)},[u(v(K),{size:"10px"}),w(" "+h(B(o.path))+"/ ",1)],8,os)):g("",!0),i("div",as,[u(l,{percentage:o.progress,status:o.status==="error"?"error":o.status==="success"?"success":"active",size:"small",label:!1},null,8,["percentage","status"])])]),i("div",rs,[o.status!=="success"?(n(),z(t,{key:0,shape:"circle",variant:"text",size:"small",onClick:M=>ue(I)},{default:p(()=>[u(v(Be))]),_:1},8,["onClick"])):(n(),z(v(Ne),{key:1,style:{color:"var(--td-success-color)","font-size":"18px"}}))])]))),128))])):g("",!0)])]),_:1},8,["visible"])}}}),ds=Ee(ls,[["__scopeId","data-v-890b3931"]]);export{ds as F};
