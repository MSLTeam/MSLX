import{D as ee,F as g,K as j,aa as se,b1 as _,b2 as u,b0 as x,aY as i,a$ as n,aX as d,b6 as y,bh as I,aZ as te,G as c,ap as p,ao as m,b5 as f,O as oe,b3 as ae,b4 as le,a_ as re}from"./index.BbdIPky0.js";import{i as ne,g as ie,h as ce,E as ue,_ as de}from"./index.CqgA5JBs.js";import{aB as pe,X as k,aq as A,a7 as fe,aI as ve,ah as he,a as me,aH as ge,aE as _e,ab as ye,aF as be,aJ as we}from"./tdesign-icons-vue-next.B3wvPiG1.js";import{M as Ce}from"./tdesign-vue-next.B9R1AJJu.js";const ze={class:"uploader-container"},Fe={class:"drop-actions"},xe={key:0,class:"queue-actions"},Ie={class:"queue-info"},Pe={key:0},De={class:"btn-group"},Ee={key:1,class:"file-list"},Me={class:"file-icon-wrapper"},Re={class:"file-content"},Ue={class:"file-header"},Be=["title"],Te={class:"meta"},Ne={key:0,class:"error"},Se={key:1},je={class:"size"},ke=["title"],Ae={class:"progress-wrapper"},Le={class:"file-action"},Oe=ee({__name:"FileUploader",props:{visible:{type:Boolean},instanceId:{},currentPath:{},allowFolder:{type:Boolean,default:!0}},emits:["update:visible","success"],setup(P,{emit:L}){const C=P,D=L,r=g([]),h=g(!1),b=g(!1),E=g(),M=g(),R=e=>{var t;const s=(t=e.split(".").pop())==null?void 0:t.toLowerCase();return["png","jpg","jpeg","gif","ico","webp"].includes(s||"")?{icon:ge,color:"var(--td-success-color)"}:["jar","zip","rar","7z","tar","gz"].includes(s||"")?{icon:_e,color:"#722ed1"}:["js","ts","py","java","c","cpp","cs","json","yml","yaml","xml","html","css","properties","conf","sh","bat"].includes(s||"")?{icon:ye,color:"var(--td-warning-color)"}:["log","txt","md","lock"].includes(s||"")?{icon:be,color:"var(--td-gray-color-6)"}:["db","db-wal","dat"].includes(s||"")?{icon:we,color:"var(--td-gray-color-8)"}:{icon:k,color:"var(--td-brand-color)"}},w=e=>e.split("/").pop()||e,z=e=>{const s=e.lastIndexOf("/");return s!==-1?e.substring(0,s):""},O=j(()=>{if(r.value.length===0)return 0;const e=r.value.reduce((s,t)=>s+t.progress,0);return Math.floor(e/r.value.length)}),V=j(()=>r.value.some(e=>e.status==="pending"||e.status==="error")),$=()=>{var e;return(e=E.value)==null?void 0:e.click()},q=()=>{var e;return(e=M.value)==null?void 0:e.click()},U=e=>{const s=e.target;if(s.files&&s.files.length>0){const a=Array.from(s.files).map(l=>({file:l,path:l.webkitRelativePath||l.name}));T(a)}s.value=""},Z=async e=>{var l;b.value=!1;const s=(l=e.dataTransfer)==null?void 0:l.items;if(!s)return;const t=[],a=Array.from(s).map(o=>o.webkitGetAsEntry()).filter(o=>o!==null);for(const o of a)o&&await B(o,t);T(t)},B=async(e,s)=>{if(e.isFile){const t=await new Promise((l,o)=>e.file(l,o)),a=e.fullPath.startsWith("/")?e.fullPath.slice(1):e.fullPath;s.push({file:t,path:a})}else if(e.isDirectory){const t=e.createReader(),a=await G(t);for(const l of a)await B(l,s)}},G=async e=>{let s=[];const t=async()=>{const a=await new Promise((l,o)=>e.readEntries(l,o));a.length>0&&(s=s.concat(a),await t())};return await t(),s},T=e=>{e.forEach(({file:s,path:t})=>{r.value.some(a=>a.path===t&&a.file.size===s.size&&a.status!=="error")||r.value.push({id:Math.random().toString(36).substring(2),file:s,path:t,status:"pending",progress:0,speed:""})})},H=async()=>{if(h.value)return;h.value=!0;const e=3,s=r.value.filter(t=>t.status==="pending"||t.status==="error");for(let t=0;t<s.length;t+=e){const a=s.slice(t,t+e);await Promise.all(a.map(l=>K(l)))}h.value=!1,r.value.every(t=>t.status==="success")&&(Ce.success("上传完成"),D("success"))},K=async e=>{e.status="uploading",e.progress=0,e.abortController=new AbortController;const s=Date.now();try{const a=(await ne()).uploadId,l=2*1024*1024,o=Math.ceil(e.file.size/l);for(let v=0;v<o;v++){if(e.abortController.signal.aborted)throw new Error("已取消");const F=v*l,N=Math.min(e.file.size,F+l),J=e.file.slice(F,N);await ie(a,v,J),e.progress=Math.floor((v+1)/o*90);const S=(Date.now()-s)/1e3;if(S>0){const W=N/1024/1024/S;e.speed=W.toFixed(1)+" MB/s"}}e.status="merging",e.progress=95,await ce(a,o),await ue(C.instanceId,a,e.path,C.currentPath),e.status="success",e.progress=100,e.speed="完成"}catch(t){t.message==="已取消"?(e.status="pending",e.speed="已取消"):(e.status="error",e.errorMsg=t.message||"失败")}},Q=e=>{var t;(t=r.value[e].abortController)==null||t.abort(),r.value.splice(e,1)},X=()=>{r.value=r.value.filter(e=>e.status!=="success")},Y=()=>D("update:visible",!1);return se(()=>r.value.forEach(e=>{var s;return(s=e.abortController)==null?void 0:s.abort()})),(e,s)=>{const t=x("t-button"),a=x("t-progress"),l=x("t-dialog");return i(),_(l,{visible:P.visible,header:"批量上传文件",width:"650px",footer:!1,onClose:Y},{default:u(()=>[n("input",{ref_key:"fileInputRef",ref:E,type:"file",multiple:"",style:{display:"none"},onChange:U},null,544),n("input",{ref_key:"folderInputRef",ref:M,type:"file",webkitdirectory:"",style:{display:"none"},onChange:U},null,544),n("div",ze,[n("div",{class:te(["drop-zone",{active:b.value}]),onDragover:s[0]||(s[0]=I(o=>b.value=!0,["prevent"])),onDragleave:s[1]||(s[1]=I(o=>b.value=!1,["prevent"])),onDrop:I(Z,["prevent"])},[c(p(pe),{size:"40px",style:{color:"var(--td-brand-color)"}}),s[4]||(s[4]=n("p",{class:"drop-text"},"拖入文件或文件夹",-1)),n("div",Fe,[c(t,{variant:"outline",size:"small",onClick:$},{icon:u(()=>[c(p(k))]),default:u(()=>[s[2]||(s[2]=m(" 选择文件",-1))]),_:1}),C.allowFolder?(i(),_(t,{key:0,variant:"outline",size:"small",onClick:q},{icon:u(()=>[c(p(A))]),default:u(()=>[s[3]||(s[3]=m(" 选择文件夹",-1))]),_:1})):y("",!0)])],34),r.value.length>0?(i(),d("div",xe,[n("span",Ie,[m(" 队列: "+f(r.value.length)+" 个 | ",1),h.value?(i(),d("span",Pe,"总进度 "+f(O.value)+"%",1)):y("",!0)]),n("div",De,[c(t,{theme:"primary",size:"small",disabled:!V.value||h.value,onClick:H},{icon:u(()=>[c(p(fe))]),default:u(()=>[m(" "+f(h.value?"上传中...":"开始上传"),1)]),_:1},8,["disabled"]),c(t,{variant:"text",size:"small",onClick:X},{icon:u(()=>[c(p(ve))]),default:u(()=>[s[5]||(s[5]=m(" 清空已完成",-1))]),_:1})])])):y("",!0),r.value.length>0?(i(),d("div",Ee,[(i(!0),d(oe,null,ae(r.value,(o,v)=>(i(),d("div",{key:o.id,class:"file-item"},[n("div",Me,[(i(),_(le(R(w(o.path)).icon),{style:re({color:R(w(o.path)).color})},null,8,["style"]))]),n("div",Re,[n("div",Ue,[n("div",{class:"name",title:w(o.path)},f(w(o.path)),9,Be),n("div",Te,[o.status==="error"?(i(),d("span",Ne,f(o.errorMsg),1)):(i(),d("span",Se,f(o.speed),1)),n("span",je,f((o.file.size/1024/1024).toFixed(2))+" MB",1)])]),z(o.path)?(i(),d("div",{key:0,class:"file-path",title:z(o.path)},[c(p(A),{size:"10px"}),m(" "+f(z(o.path))+"/ ",1)],8,ke)):y("",!0),n("div",Ae,[c(a,{percentage:o.progress,status:o.status==="error"?"error":o.status==="success"?"success":"active",size:"small",label:!1},null,8,["percentage","status"])])]),n("div",Le,[o.status!=="success"?(i(),_(t,{key:0,shape:"circle",variant:"text",size:"small",onClick:F=>Q(v)},{default:u(()=>[c(p(he))]),_:1},8,["onClick"])):(i(),_(p(me),{key:1,style:{color:"var(--td-success-color)","font-size":"18px"}}))])]))),128))])):y("",!0)])]),_:1},8,["visible"])}}}),Ge=de(Oe,[["__scopeId","data-v-feb65315"]]);export{Ge as F};
